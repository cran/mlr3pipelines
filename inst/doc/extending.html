<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Martin Binder" />


<title>Adding new PipeOps</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Adding new PipeOps</h1>
<h4 class="author">Martin Binder</h4>


<div id="TOC">
<ul>
<li><a href="#ext-pipeopcopy" id="toc-ext-pipeopcopy">General Case
Example: <code>PipeOpCopy</code></a></li>
<li><a href="#ext-pipe-preproc" id="toc-ext-pipe-preproc">Special Case:
Preprocessing</a></li>
<li><a href="#special-case-preprocessing-with-simple-train" id="toc-special-case-preprocessing-with-simple-train">Special Case:
Preprocessing with Simple Train</a></li>
<li><a href="#ext-pipe-hyperpars" id="toc-ext-pipe-hyperpars">Hyperparameters</a></li>
</ul>
</div>

<p>This vignette showcases how the <code>mlr3pipelines</code> package
can be extended to include custom <code>PipeOp</code>s. To run the
following examples, we will need a <code>Task</code>; we are using the
well-known “Iris” task:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;mlr3&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">&quot;iris&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">data</span>()</span></code></pre></div>
<pre><code>##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##         &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;
##   1:    setosa          1.4         0.2          5.1         3.5
##   2:    setosa          1.4         0.2          4.9         3.0
##   3:    setosa          1.3         0.2          4.7         3.2
##   4:    setosa          1.5         0.2          4.6         3.1
##   5:    setosa          1.4         0.2          5.0         3.6
##  ---                                                            
## 146: virginica          5.2         2.3          6.7         3.0
## 147: virginica          5.0         1.9          6.3         2.5
## 148: virginica          5.2         2.0          6.5         3.0
## 149: virginica          5.4         2.3          6.2         3.4
## 150: virginica          5.1         1.8          5.9         3.0</code></pre>
<p><code>mlr3pipelines</code> is fundamentally built around <a href="https://r6.r-lib.org/"><code>R6</code></a>. When planning to
create custom <code>PipeOp</code> objects, it can only help to <a href="https://adv-r.hadley.nz/r6.html">familiarize yourself with
it</a>.</p>
<p>In principle, all a <code>PipeOp</code> must do is inherit from the
<code>PipeOp</code> R6 class and implement the <code>.train()</code> and
<code>.predict()</code> functions. There are, however, several auxiliary
subclasses that can make the creation of <em>certain</em> operations
much easier.</p>
<div id="ext-pipeopcopy" class="section level3">
<h3>General Case Example: <code>PipeOpCopy</code></h3>
<p>A very simple yet useful <code>PipeOp</code> is
<code>PipeOpCopy</code>, which takes a single input and creates a
variable number of output channels, all of which receive a copy of the
input data. It is a simple example that showcases the important steps in
defining a custom <code>PipeOp</code>. We will show a simplified version
here, <strong><code>PipeOpCopyTwo</code></strong>, that creates exactly
two copies of its input data.</p>
<div id="first-steps-inheriting-from-pipeop" class="section level4">
<h4>First Steps: Inheriting from <code>PipeOp</code></h4>
<p>The first part of creating a custom <code>PipeOp</code> is inheriting
from <code>PipeOp</code>. We make a mental note that we need to
implement a <code>.train()</code> and a <code>.predict()</code>
function, and that we probably want to have an <code>initialize()</code>
as well:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>PipeOpCopyTwo <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">&quot;PipeOpCopyTwo&quot;</span>,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOp,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">&quot;copy.two&quot;</span>) {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>      ....</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  private <span class="sc">==</span> <span class="fu">list</span>(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      ....</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      ....</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Note, that <strong>private</strong> methods, e.g. <code>.train</code>
and <code>.predict</code> etc are prefixed with a <code>.</code>.</p>
</div>
<div id="channel-definitions" class="section level4">
<h4>Channel Definitions</h4>
<p>We need to tell the <code>PipeOp</code> the layout of its channels:
How many there are, what their names are going to be, and what types are
acceptable. This is done on initialization of the <code>PipeOp</code>
(using a <code>super$initialize</code> call) by giving the
<code>input</code> and <code>output</code> <code>data.table</code>
objects. These must have three columns: a <code>&quot;name&quot;</code> column
giving the names of input and output channels, and a
<code>&quot;train&quot;</code> and <code>&quot;predict&quot;</code> column naming the class
of objects we expect during training and prediction as input / output. A
special value for these classes is <code>&quot;*&quot;</code>, which indicates
that any class will be accepted; our simple copy operator accepts any
kind of input, so this will be useful. We have only one input, but two
output channels.</p>
<p>By convention, we name a single channel <code>&quot;input&quot;</code> or
<code>&quot;output&quot;</code>, and a group of channels [<code>&quot;input1&quot;</code>,
<code>&quot;input2&quot;</code>, …], unless there is a reason to give specific
different names. Therefore, our <code>input</code>
<code>data.table</code> will have a single row
<code>&lt;&quot;input&quot;, &quot;*&quot;, &quot;*&quot;&gt;</code>, and our <code>output</code>
table will have two rows, <code>&lt;&quot;output1&quot;, &quot;*&quot;, &quot;*&quot;&gt;</code> and
<code>&lt;&quot;output2&quot;, &quot;*&quot;, &quot;*&quot;&gt;</code>.</p>
<p>All of this is given to the <code>PipeOp</code> creator. Our
<code>initialize()</code> will thus look as follows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>initialize <span class="ot">=</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">&quot;copy.two&quot;</span>) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  input <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="st">&quot;input&quot;</span>, <span class="at">train =</span> <span class="st">&quot;*&quot;</span>, <span class="at">predict =</span> <span class="st">&quot;*&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the following will create two rows and automatically fill the `train`</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and `predict` cols with &quot;*&quot;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">c</span>(<span class="st">&quot;output1&quot;</span>, <span class="st">&quot;output2&quot;</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">train =</span> <span class="st">&quot;*&quot;</span>, <span class="at">predict =</span> <span class="st">&quot;*&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  super<span class="sc">$</span><span class="fu">initialize</span>(id,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">input =</span> input,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> output</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="train-and-predict" class="section level4">
<h4>Train and Predict</h4>
<p>Both <code>.train()</code> and <code>.predict()</code> will receive a
<code>list</code> as input and must give a <code>list</code> in return.
According to our <code>input</code> and <code>output</code> definitions,
we will always get a list with a single element as input, and will need
to return a list with two elements. Because all we want to do is create
two copies, we will just create the copies using
<code>c(inputs, inputs)</code>.</p>
<p>Two things to consider:</p>
<ul>
<li><p>The <code>.train()</code> function must always modify the
<code>self$state</code> variable to something that is not
<code>NULL</code> or <code>NO_OP</code>. This is because the
<code>$state</code> slot is used as a signal that <code>PipeOp</code>
has been trained on data, even if the state itself is not important to
the <code>PipeOp</code> (as in our case). Therefore, our
<code>.train()</code> will set
<code>self$state = list()</code>.</p></li>
<li><p>It is not necessary to “clone” our input or make deep copies,
because we don’t modify the data. However, if we were changing a
reference-passed object, for example by changing data in a
<code>Task</code>, we would have to make a deep copy first. This is
because a <code>PipeOp</code> may never modify its input object by
reference.</p></li>
</ul>
<p>Our <code>.train()</code> and <code>.predict()</code> functions are
now:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>.train <span class="ot">=</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>.predict <span class="ot">=</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="putting-it-together" class="section level4">
<h4>Putting it Together</h4>
<p>The whole definition thus becomes</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>PipeOpCopyTwo <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">&quot;PipeOpCopyTwo&quot;</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOp,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">&quot;copy.two&quot;</span>) {</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(id,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">input =</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="st">&quot;input&quot;</span>, <span class="at">train =</span> <span class="st">&quot;*&quot;</span>, <span class="at">predict =</span> <span class="st">&quot;*&quot;</span>),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">output =</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">&quot;output1&quot;</span>, <span class="st">&quot;output2&quot;</span>),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">train =</span> <span class="st">&quot;*&quot;</span>, <span class="at">predict =</span> <span class="st">&quot;*&quot;</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>We can create an instance of our <code>PipeOp</code>, put it in a
graph, and see what happens when we train it on something:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;mlr3pipelines&quot;</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>poct <span class="ot">=</span> PipeOpCopyTwo<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(poct)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(gr)</span></code></pre></div>
<pre><code>## Graph with 1 PipeOps:
##        ID         State sccssors prdcssors
##    &lt;char&gt;        &lt;char&gt;   &lt;char&gt;    &lt;char&gt;
##  copy.two &lt;&lt;UNTRAINED&gt;&gt;</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(result)</span></code></pre></div>
<pre><code>## List of 2
##  $ copy.two.output1:Classes &#39;TaskClassif&#39;, &#39;TaskSupervised&#39;, &#39;Task&#39;, &#39;R6&#39; &lt;TaskClassif:iris&gt; 
##  $ copy.two.output2:Classes &#39;TaskClassif&#39;, &#39;TaskSupervised&#39;, &#39;Task&#39;, &#39;R6&#39; &lt;TaskClassif:iris&gt;</code></pre>
</div>
</div>
<div id="ext-pipe-preproc" class="section level3">
<h3>Special Case: Preprocessing</h3>
<p>Many <code>PipeOp</code>s perform an operation on exactly one
<code>Task</code>, and return exactly one <code>Task</code>. They may
even not care about the “Target” / “Outcome” variable of that task, and
only do some modification of some input data. However, it is usually
important to them that the <code>Task</code> on which they perform
prediction has the same data columns as the <code>Task</code> on which
they train. For these cases, the auxiliary base class
<code>PipeOpTaskPreproc</code> exists. It inherits from
<code>PipeOp</code> itself, and other <code>PipeOp</code>s should use it
if they fall in the kind of use-case named above.</p>
<p>When inheriting from <code>PipeOpTaskPreproc</code>, one must either
implement the private methods <code>.train_task()</code> and
<code>.predict_task()</code>, or the methods <code>.train_dt()</code>,
<code>.predict_dt()</code>, depending on whether wants to operate on a
<code>Task</code> object or on its data as <code>data.table</code>s. In
the second case, one can optionally also overload the
<code>.select_cols()</code> method, which chooses which of the incoming
<code>Task</code>’s features are given to the <code>.train_dt()</code> /
<code>.predict_dt()</code> functions.</p>
<p>The following will show two examples: <code>PipeOpDropNA</code>,
which removes a <code>Task</code>’s rows with missing values during
training (and implements <code>.train_task()</code> and
<code>.predict_task()</code>), and <code>PipeOpScale</code>, which
scales a <code>Task</code>’s numeric columns (and implements
<code>.train_dt()</code>, <code>.predict_dt()</code>, and
<code>.select_cols()</code>).</p>
<div id="example-pipeopdropna" class="section level4">
<h4>Example: <code>PipeOpDropNA</code></h4>
<p>Dropping rows with missing values may be important when training a
model that can not handle them.</p>
<p>Because <a href="https://github.com/mlr-org/mlr3"><code>mlr3</code></a>
<code>Tasks</code> only contain a view to the underlying data, it is not
necessary to modify data to remove rows with missing values. Instead,
the rows can be removed using the <code>Task</code>’s
<code>$filter</code> method, which modifies the <code>Task</code>
in-place. This is done in the private method <code>.train_task()</code>.
We take care that we also set the <code>$state</code> slot to signal
that the <code>PipeOp</code> was trained.</p>
<p>The private method <code>.predict_task()</code> does not need to do
anything; removing missing values during prediction is not as useful,
since learners that cannot handle them will just ignore the respective
rows. Furthermore, <a href="https://github.com/mlr-org/mlr3"><code>mlr3</code></a> expects a
<code>Learner</code> to always return just as many predictions as it was
given input rows, so a <code>PipeOp</code> that removes
<code>Task</code> rows during training can not be used inside a
<code>GraphLearner</code>.</p>
<p>When we inherit from <code>PipeOpTaskPreproc</code>, it sets the
<code>input</code> and <code>output</code> <code>data.table</code>s for
us to only accept a single <code>Task</code>. The only thing we do
during <code>initialize()</code> is therefore to set an <code>id</code>
(which can optionally be changed by the user).</p>
<p>The complete <code>PipeOpDropNA</code> can therefore be written as
follows. Note that it inherits from <code>PipeOpTaskPreproc</code>,
unlike the <code>PipeOpCopyTwo</code> example from above:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>PipeOpDropNA <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">&quot;PipeOpDropNA&quot;</span>,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreproc,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">&quot;drop.na&quot;</span>) {</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(id)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train_task =</span> <span class="cf">function</span>(task) {</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>      featuredata <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> task<span class="sc">$</span>feature_names)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>      exclude <span class="ot">=</span> <span class="fu">apply</span>(<span class="fu">is.na</span>(featuredata), <span class="dv">1</span>, any)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span><span class="fu">filter</span>(task<span class="sc">$</span>row_ids[<span class="sc">!</span>exclude])</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict_task =</span> <span class="cf">function</span>(task) {</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># nothing to be done</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>      task</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>To test this <code>PipeOp</code>, we create a small task with missing
values:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>smalliris <span class="ot">=</span> iris[(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">*</span> <span class="dv">30</span>, ]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>smalliris[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>smalliris[<span class="dv">2</span>, <span class="dv">2</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>sitask <span class="ot">=</span> <span class="fu">as_task_classif</span>(smalliris, <span class="at">target =</span> <span class="st">&quot;Species&quot;</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sitask<span class="sc">$</span><span class="fu">data</span>())</span></code></pre></div>
<pre><code>##       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##        &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;
## 1:     setosa          1.6         0.2           NA         3.2
## 2: versicolor          3.9         1.4          5.2          NA
## 3: versicolor          4.0         1.3          5.5         2.5
## 4:  virginica          5.0         1.5          6.0         2.2
## 5:  virginica          5.1         1.8          5.9         3.0</code></pre>
<p>We test this by feeding it to a new <code>Graph</code> that uses
<code>PipeOpDropNA</code>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpDropNA<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>filtered_task <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(sitask)[[<span class="dv">1</span>]]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(filtered_task<span class="sc">$</span><span class="fu">data</span>())</span></code></pre></div>
<pre><code>##       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##        &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;
## 1: versicolor          4.0         1.3          5.5         2.5
## 2:  virginica          5.0         1.5          6.0         2.2
## 3:  virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
<div id="example-pipeopscalealways" class="section level4">
<h4>Example: <code>PipeOpScaleAlways</code></h4>
<p>An often-applied preprocessing step is to simply
<strong>center</strong> and/or <strong>scale</strong> the data to mean
<span class="math inline">\(0\)</span> and standard deviation <span class="math inline">\(1\)</span>. This fits the
<code>PipeOpTaskPreproc</code> pattern quite well. Because it always
replaces all columns that it operates on, and does not require any
information about the task’s target, it only needs to overload the
<code>.train_dt()</code> and <code>.predict_dt()</code> functions. This
saves some boilerplate-code from getting the correct feature columns out
of the task, and replacing them after modification.</p>
<p>Because scaling only makes sense on numeric features, we want to
instruct <code>PipeOpTaskPreproc</code> to give us only these numeric
columns. We do this by overloading the <code>.select_cols()</code>
function: It is called by the class to determine which columns to pass
to <code>.train_dt()</code> and <code>.predict_dt()</code>. Its input is
the <code>Task</code> that is being transformed, and it should return a
<code>character</code> vector of all features to work with. When it is
not overloaded, it uses all columns; instead, we will set it to only
give us numeric columns. Because the <code>levels()</code> of the data
table given to <code>.train_dt()</code> and <code>.predict_dt()</code>
may be different from the <code>Task</code>’s levels, these functions
must also take a <code>levels</code> argument that is a named list of
column names indicating their levels. When working with numeric data,
this argument can be ignored, but it should be used instead of
<code>levels(dt[[column]])</code> for factorial or character
columns.</p>
<p>This is the first <code>PipeOp</code> where we will be using the
<code>$state</code> slot for something useful: We save the centering
offset and scaling coefficient and use it in
<code>$.predict()</code>!</p>
<p>For simplicity, we are not using hyperparameters and will always
scale and center all data. Compare this <code>PipeOpScaleAlways</code>
operator to the one defined inside the <code>mlr3pipelines</code>
package, <code>PipeOpScale</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>PipeOpScaleAlways <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">&quot;PipeOpScaleAlways&quot;</span>,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreproc,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">&quot;scale.always&quot;</span>) {</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.select_cols =</span> <span class="cf">function</span>(task) {</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span>feature_types[type <span class="sc">==</span> <span class="st">&quot;numeric&quot;</span>, id]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train_dt =</span> <span class="cf">function</span>(dt, levels, target) {</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>      sc <span class="ot">=</span> <span class="fu">scale</span>(<span class="fu">as.matrix</span>(dt))</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">center =</span> <span class="fu">attr</span>(sc, <span class="st">&quot;scaled:center&quot;</span>),</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale =</span> <span class="fu">attr</span>(sc, <span class="st">&quot;scaled:scale&quot;</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>      sc</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict_dt =</span> <span class="cf">function</span>(dt, levels) {</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t</span>((<span class="fu">t</span>(dt) <span class="sc">-</span> self<span class="sc">$</span>state<span class="sc">$</span>center) <span class="sc">/</span> self<span class="sc">$</span>state<span class="sc">$</span>scale)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><em>(Note for the observant: If you check <code>PipeOpScale.R</code>
from the <code>mlr3pipelines</code> package, you will notice that is
uses “<code>get(&quot;type&quot;)</code>” and “<code>get(&quot;id&quot;)</code>” instead of
“<code>type</code>” and “<code>id</code>”, because the static code
checker on CRAN would otherwise complain about references to undefined
variables. This is a “problem” with <code>data.table</code> and not
exclusive to <code>mlr3pipelines</code>.)</em></p>
<p>We can, again, create a new <code>Graph</code> that uses this
<code>PipeOp</code> to test it. Compare the resulting data to the
original “iris” <code>Task</code> data printed at the beginning:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlways<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code></pre></div>
<pre><code>##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##         &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;
##   1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199
##   2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881
##   3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751
##   4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935
##   5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015
##  ---                                                            
## 146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881
## 147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961
## 148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881
## 149: virginica    0.9301544   1.4439941   0.43072244  0.78617383
## 150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</code></pre>
</div>
</div>
<div id="special-case-preprocessing-with-simple-train" class="section level3">
<h3>Special Case: Preprocessing with Simple Train</h3>
<p>It is possible to make even further simplifications for many
<code>PipeOp</code>s that perform mostly the same operation during
training and prediction. The point of <code>Task</code> preprocessing is
often to modify the training data in mostly the same way as prediction
data (but in a way that <em>may</em> depend on training data).</p>
<p>Consider constant feature removal, for example: The goal is to remove
features that have no variance, or only a single factor level. However,
what features get removed must be decided during <em>training</em>, and
may only depend on training data. Furthermore, the actual process of
removing features is the same during training and prediction.</p>
<p>A simplification to make is therefore to have a private method
<code>.get_state(task)</code> which sets the <code>$state</code> slot
during training, and a private method <code>.transform(task)</code>,
which gets called both during training <em>and</em> prediction. This is
done in the <code>PipeOpTaskPreprocSimple</code> class. Just like
<code>PipeOpTaskPreproc</code>, one can inherit from this and overload
these functions to get a <code>PipeOp</code> that performs preprocessing
with very little boilerplate code.</p>
<p>Just like <code>PipeOpTaskPreproc</code>,
<code>PipeOpTaskPreprocSimple</code> offers the possibility to instead
overload the <code>.get_state_dt(dt, levels)</code> and
<code>.transform_dt(dt, levels)</code> methods (and optionally, again,
the <code>.select_cols(task)</code> function) to operate on
<code>data.table</code> feature data instead of the whole
<code>Task</code>.</p>
<p>Even some methods that do not use
<code>PipeOpTaskPreprocSimple</code> <em>could</em> work in a similar
way: The <code>PipeOpScaleAlways</code> example from above will be shown
to also work with this paradigm.</p>
<div id="example-pipeopdropconst" class="section level4">
<h4>Example: <code>PipeOpDropConst</code></h4>
<p>A typical example of a preprocessing operation that does almost the
same operation during training and prediction is an operation that drops
features depending on a criterion that is evaluated during training. One
simple example of this is dropping constant features. Because the <a href="https://github.com/mlr-org/mlr3"><code>mlr3</code></a>
<code>Task</code> class offers a flexible view on underlying data, it is
most efficient to drop columns from the task directly using its
<code>$select()</code> function, so the
<code>.get_state_dt(dt, levels)</code> /
<code>.transform_dt(dt, levels)</code> functions will <em>not</em> get
used; instead we overload the <code>.get_state(task)</code> and
<code>.transform(task)</code> methods.</p>
<p>The <code>.get_state()</code> function’s result is saved to the
<code>$state</code> slot, so we want to return something that is useful
for dropping features. We choose to save the names of all the columns
that have nonzero variance. For brevity, we use
<code>length(unique(column)) &gt; 1</code> to check whether more than
one distinct value is present; a more sophisticated version could have a
tolerance parameter for numeric values that are very close to each
other.</p>
<p>The <code>.transform()</code> method is evaluated both during
training <em>and</em> prediction, and can rely on the
<code>$state</code> slot being present. All it does here is call the
<code>Task$select</code> function with the columns we chose to keep.</p>
<p>The full <code>PipeOp</code> could be written as follows:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>PipeOpDropConst <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">&quot;PipeOpDropConst&quot;</span>,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreprocSimple,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">&quot;drop.const&quot;</span>) {</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.get_state =</span> <span class="cf">function</span>(task) {</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>      data <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> task<span class="sc">$</span>feature_names)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>      nonconst <span class="ot">=</span> <span class="fu">sapply</span>(data, <span class="cf">function</span>(column) <span class="fu">length</span>(<span class="fu">unique</span>(column)) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">cnames =</span> <span class="fu">colnames</span>(data)[nonconst])</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">.transform =</span> <span class="cf">function</span>(task) {</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span><span class="fu">select</span>(self<span class="sc">$</span>state<span class="sc">$</span>cnames)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>This can be tested using the first five rows of the “Iris”
<code>Task</code>, for which one feature (<code>&quot;Petal.Width&quot;</code>) is
constant:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>irishead <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>irishead<span class="sc">$</span><span class="fu">data</span>()</span></code></pre></div>
<pre><code>##    Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##     &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;
## 1:  setosa          1.4         0.2          5.1         3.5
## 2:  setosa          1.4         0.2          4.9         3.0
## 3:  setosa          1.3         0.2          4.7         3.2
## 4:  setosa          1.5         0.2          4.6         3.1
## 5:  setosa          1.4         0.2          5.0         3.6</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpDropConst<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>dropped_task <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(irishead)[[<span class="dv">1</span>]]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>dropped_task<span class="sc">$</span><span class="fu">data</span>()</span></code></pre></div>
<pre><code>##    Species Petal.Length Sepal.Length Sepal.Width
##     &lt;fctr&gt;        &lt;num&gt;        &lt;num&gt;       &lt;num&gt;
## 1:  setosa          1.4          5.1         3.5
## 2:  setosa          1.4          4.9         3.0
## 3:  setosa          1.3          4.7         3.2
## 4:  setosa          1.5          4.6         3.1
## 5:  setosa          1.4          5.0         3.6</code></pre>
<p>We can also see that the <code>$state</code> was correctly set.
Calling <code>$.predict()</code> with this graph, even with different
data (the whole Iris <code>Task</code>!) will still drop the
<code>&quot;Petal.Width&quot;</code> column, as it should.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span>pipeops<span class="sc">$</span>drop.const<span class="sc">$</span>state</span></code></pre></div>
<pre><code>## $cnames
## [1] &quot;Petal.Length&quot; &quot;Sepal.Length&quot; &quot;Sepal.Width&quot; 
## 
## $affected_cols
## [1] &quot;Petal.Length&quot; &quot;Petal.Width&quot;  &quot;Sepal.Length&quot; &quot;Sepal.Width&quot; 
## 
## $intasklayout
## Key: &lt;id&gt;
##              id    type
##          &lt;char&gt;  &lt;char&gt;
## 1: Petal.Length numeric
## 2:  Petal.Width numeric
## 3: Sepal.Length numeric
## 4:  Sepal.Width numeric
## 
## $outtasklayout
## Key: &lt;id&gt;
##              id    type
##          &lt;char&gt;  &lt;char&gt;
## 1: Petal.Length numeric
## 2: Sepal.Length numeric
## 3:  Sepal.Width numeric
## 
## $outtaskshell
## Empty data.table (0 rows and 4 cols): Species,Petal.Length,Sepal.Length,Sepal.Width</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>dropped_predict <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">predict</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>dropped_predict<span class="sc">$</span><span class="fu">data</span>()</span></code></pre></div>
<pre><code>##        Species Petal.Length Sepal.Length Sepal.Width
##         &lt;fctr&gt;        &lt;num&gt;        &lt;num&gt;       &lt;num&gt;
##   1:    setosa          1.4          5.1         3.5
##   2:    setosa          1.4          4.9         3.0
##   3:    setosa          1.3          4.7         3.2
##   4:    setosa          1.5          4.6         3.1
##   5:    setosa          1.4          5.0         3.6
##  ---                                                
## 146: virginica          5.2          6.7         3.0
## 147: virginica          5.0          6.3         2.5
## 148: virginica          5.2          6.5         3.0
## 149: virginica          5.4          6.2         3.4
## 150: virginica          5.1          5.9         3.0</code></pre>
</div>
<div id="example-pipeopscalealwayssimple" class="section level4">
<h4>Example: <code>PipeOpScaleAlwaysSimple</code></h4>
<p>This example will show how a <code>PipeOpTaskPreprocSimple</code> can
be used when only working on feature data in form of a
<code>data.table</code>. Instead of calling the <code>scale()</code>
function, the <code>center</code> and <code>scale</code> values are
calculated directly and saved to the <code>$state</code> slot. The
<code>.transform_dt()</code> function will then perform the same
operation during both training and prediction: subtract the
<code>center</code> and divide by the <code>scale</code> value. As in
the <a href="#example-pipeopscalealways"><code>PipeOpScaleAlways</code>
example above</a>, we use <code>.select_cols()</code> so that we only
work on numeric columns.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>PipeOpScaleAlwaysSimple <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">&quot;PipeOpScaleAlwaysSimple&quot;</span>,</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreprocSimple,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">&quot;scale.always.simple&quot;</span>) {</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.select_cols =</span> <span class="cf">function</span>(task) {</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span>feature_types[type <span class="sc">==</span> <span class="st">&quot;numeric&quot;</span>, id]</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">.get_state_dt =</span> <span class="cf">function</span>(dt, levels, target) {</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">center =</span> <span class="fu">sapply</span>(dt, mean),</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale =</span> <span class="fu">sapply</span>(dt, sd)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">.transform_dt =</span> <span class="cf">function</span>(dt, levels) {</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t</span>((<span class="fu">t</span>(dt) <span class="sc">-</span> self<span class="sc">$</span>state<span class="sc">$</span>center) <span class="sc">/</span> self<span class="sc">$</span>state<span class="sc">$</span>scale)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>We can compare this <code>PipeOp</code> to the one above to show that
it behaves the same.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlways<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>result_posa <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlwaysSimple<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>result_posa_simple <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>result_posa<span class="sc">$</span><span class="fu">data</span>()</span></code></pre></div>
<pre><code>##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##         &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;
##   1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199
##   2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881
##   3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751
##   4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935
##   5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015
##  ---                                                            
## 146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881
## 147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961
## 148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881
## 149: virginica    0.9301544   1.4439941   0.43072244  0.78617383
## 150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>result_posa_simple<span class="sc">$</span><span class="fu">data</span>()</span></code></pre></div>
<pre><code>##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##         &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;
##   1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199
##   2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881
##   3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751
##   4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935
##   5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015
##  ---                                                            
## 146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881
## 147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961
## 148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881
## 149: virginica    0.9301544   1.4439941   0.43072244  0.78617383
## 150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</code></pre>
</div>
</div>
<div id="ext-pipe-hyperpars" class="section level3">
<h3>Hyperparameters</h3>
<p><code>mlr3pipelines</code> uses the <a href="https://paradox.mlr-org.com"><code>paradox</code></a> package to
define parameter spaces for <code>PipeOp</code>s. Parameters for
<code>PipeOp</code>s can modify their behavior in certain ways,
e.g. switch centering or scaling off in the <code>PipeOpScale</code>
operator. The unified interface makes it possible to have parameters for
whole <code>Graph</code>s that modify the individual
<code>PipeOp</code>’s behavior. The <code>Graph</code>s, when
encapsulated in <code>GraphLearner</code>s, can even be tuned using the
tuning functionality in <a href="https://mlr3tuning.mlr-org.com"><code>mlr3tuning</code></a>.</p>
<p>Hyperparameters are declared during initialization, when calling the
<code>PipeOp</code>’s <code>$initialize()</code> function, by giving a
<code>param_set</code> argument. The <code>param_set</code> must be a
<code>ParamSet</code> from the <a href="https://paradox.mlr-org.com"><code>paradox</code></a> package; see
its documentation for more information on how to define parameter
spaces. After construction, the <code>ParamSet</code> can be accessed
through the <code>$param_set</code> slot. While it is <em>possible</em>
to modify this <code>ParamSet</code>, using e.g. the <code>$add()</code>
and <code>$add_dep()</code> functions, <em>after</em> adding it to the
<code>PipeOp</code>, it is strongly advised against.</p>
<p>Hyperparameters can be set and queried through the
<code>$values</code> slot. When setting hyperparameters, they are
automatically checked to satisfy all conditions set by the
<code>$param_set</code>, so it is not necessary to type check them. Be
aware that it is always possible to <em>remove</em> hyperparameter
values.</p>
<p>When a <code>PipeOp</code> is initialized, it usually does not have
any parameter values—<code>$values</code> takes the value
<code>list()</code>. It is possible to set initial parameter values in
the <code>$initialize()</code> constructor; this must be done
<em>after</em> the <code>super$initialize()</code> call where the
corresponding <code>ParamSet</code> must be supplied. This is because
setting <code>$values</code> checks against the current
<code>$param_set</code>, which would fail if the <code>$param_set</code>
was not set yet.</p>
<p>When using an underlying library function (the <code>scale</code>
function in <code>PipeOpScale</code>, say), then there is usually a
“default” behaviour of that function when a parameter is not given. It
is good practice to use this default behaviour whenever a parameter is
not set (or when it was removed). This can easily be done when using the
<a href="https://mlr3misc.mlr-org.com"><code>mlr3misc</code></a>
library’s <code>mlr3misc::invoke()</code> function, which has
functionality similar to <code>&quot;do.call()&quot;</code>.</p>
<div id="hyperparameter-example-pipeopscale" class="section level4">
<h4>Hyperparameter Example: <code>PipeOpScale</code></h4>
<p>How to use hyperparameters can best be shown through the example of
<code>PipeOpScale</code>, which is very similar to the example above,
<code>PipeOpScaleAlways</code>. The difference is made by the presence
of hyperparameters. <code>PipeOpScale</code> constructs a
<code>ParamSet</code> in its <code>$initialize</code> function and
passes this on to the <code>super$initialize</code> function:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>PipeOpScale<span class="sc">$</span>public_methods<span class="sc">$</span>initialize</span></code></pre></div>
<pre><code>## function (id = &quot;scale&quot;, param_vals = list()) 
## .__PipeOpScale__initialize(self = self, private = private, super = super, 
##     id = id, param_vals = param_vals)
## &lt;environment: namespace:mlr3pipelines&gt;</code></pre>
<p>The user has access to this and can set and get parameters. Types are
automatically checked:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>pss <span class="ot">=</span> <span class="fu">po</span>(<span class="st">&quot;scale&quot;</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pss<span class="sc">$</span>param_set)</span></code></pre></div>
<pre><code>## &lt;ParamSet:scale&gt;
##                id    class lower upper nlevels
##            &lt;char&gt;   &lt;char&gt; &lt;num&gt; &lt;num&gt;   &lt;num&gt;
## 1:         center ParamLgl    NA    NA       2
## 2:          scale ParamLgl    NA    NA       2
## 3:         robust ParamLgl    NA    NA       2
## 4: affect_columns ParamUty    NA    NA     Inf
##                                                                                      default
##                                                                                       &lt;list&gt;
## 1:                                                                                      TRUE
## 2:                                                                                      TRUE
## 3: &lt;NoDefault&gt;\n  Public:\n    clone: function (deep = FALSE) \n    initialize: function () 
## 4:                                                                             &lt;Selector[1]&gt;
##     value
##    &lt;list&gt;
## 1:       
## 2:       
## 3:  FALSE
## 4:</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pss<span class="sc">$</span>param_set<span class="sc">$</span>values)</span></code></pre></div>
<pre><code>## $robust
## [1] FALSE
## 
## $center
## [1] FALSE</code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>scale <span class="ot">=</span> <span class="st">&quot;TRUE&quot;</span> <span class="co"># bad input is checked!</span></span></code></pre></div>
<pre><code>## Error in self$assert(xs): Assertion on &#39;xs&#39; failed: scale: Must be of type &#39;logical flag&#39;, not &#39;character&#39;.</code></pre>
<p>How <code>PipeOpScale</code> handles its parameters can be seen in
its <code>$.train_dt</code> method: It gets the relevant parameters from
its <code>$values</code> slot and uses them in the
<code>mlr3misc::invoke()</code> call. This has the advantage over
calling <code>scale()</code> directly that if a parameter is not given,
its default value from the <code>&quot;scale()&quot;</code> function will be
used.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>PipeOpScale<span class="sc">$</span>private_methods<span class="sc">$</span>.train_dt</span></code></pre></div>
<pre><code>## function (dt, levels, target) 
## .__PipeOpScale__.train_dt(self = self, private = private, super = super, 
##     dt = dt, levels = levels, target = target)
## &lt;environment: namespace:mlr3pipelines&gt;</code></pre>
<p>Another change that is necessary compared to
<code>PipeOpScaleAlways</code> is that the attributes
<code>&quot;scaled:scale&quot;</code> and <code>&quot;scaled:center&quot;</code> are not
always present, depending on parameters, and possibly need to be set to
default values <span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span>, respectively.</p>
<p>It is now even possible (if a bit pointless) to call
<code>PipeOpScale</code> with both <code>scale</code> and
<code>center</code> set to <code>FALSE</code>, which returns the
original dataset, unchanged.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>scale <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(pss)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code></pre></div>
<pre><code>##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##         &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;
##   1:    setosa          1.4         0.2          5.1         3.5
##   2:    setosa          1.4         0.2          4.9         3.0
##   3:    setosa          1.3         0.2          4.7         3.2
##   4:    setosa          1.5         0.2          4.6         3.1
##   5:    setosa          1.4         0.2          5.0         3.6
##  ---                                                            
## 146: virginica          5.2         2.3          6.7         3.0
## 147: virginica          5.0         1.9          6.3         2.5
## 148: virginica          5.2         2.0          6.5         3.0
## 149: virginica          5.4         2.3          6.2         3.4
## 150: virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
